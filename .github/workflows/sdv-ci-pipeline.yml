name: SDV Developer Console CI

# Trigger the pipeline on push or pull request to the 'main' branch
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # --- STAGE 1: SETUP ---
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Set up Node.js (for Newman)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --- STAGE 2: UNIT TESTS (Logic Check) ---
      # We verify your Java logic (JUnit + Mockito) before starting heavy containers
      - name: Build & Unit Test (Message Queue)
        run: |
          cd message-queue-service/app 
          mvn clean install -DskipTests=false

      - name: Build & Unit Test (Webhook Service)
        run: |
          cd webhook-management-service/app 
          mvn clean install -DskipTests=false

      - name: Build Other Services (Skipping tests for speed if needed)
        run: |
          cd scenario-library-service/app && mvn clean install -DskipTests
          cd ../..
          cd tracks-management-service/app && mvn clean install -DskipTests
          cd ../..
          cd dco-gateway/app && mvn clean install -DskipTests

      # --- STAGE 3: START ENVIRONMENT (Infrastructure Check) ---
      - name: Start Docker Environment
        run: |
          docker-compose up -d --build
          echo "⏳ Waiting 60s for services to stabilize..."
          sleep 60

      # --- STAGE 4: HEALTH CHECKS (Pulse Check) ---
      - name: Verify Service Health
        run: |
          # Simple curl loop to check if Gateway is up
          echo "Checking API Gateway..."
          for i in {1..10}; do
            if curl -s http://localhost:8080/actuator/health | grep "UP"; then
              echo "✅ Gateway is UP"
              break
            fi
            echo "zzZ Waiting for Gateway..."
            sleep 5
          done

      # --- STAGE 5: SEED DATABASE (Fix Missing Tables) ---
      # This runs your script to create the webhook_deliveries table
      - name: Seed Database
        run: |
          chmod +x seed-database.sh
          ./seed-database.sh

      # --- STAGE 6: E2E WORKFLOW (User Experience Check) ---
      - name: Install Newman
        run: npm install -g newman

      - name: Run Postman E2E Tests
        run: |
          if [ -f "E2E_Demo_API.postman_collection.json" ]; then
            newman run E2E_Demo_API.postman_collection.json --reporters cli
          else
            echo "⚠️ Postman collection not found. Skipping E2E step for now."
          fi

      # --- DEBUGGING ---
      - name: Dump Docker Logs (If Failure)
        if: failure()
        run: docker-compose logs