name: SDV Developer Console CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # --- STAGE 1: SETUP ---
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Set up Node.js (for UI Build & Newman)
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      # --- STAGE 2: BUILD & UNIT TEST (JAVA) ---
      
      # 1. Webhook Service (With Tests)
      - name: Build & Test Webhook Service
        run: |
          echo "ğŸ“¦ Installing Webhook Parent POM..."
          cd webhook-management-service
          mvn -N clean install
          
          echo "ğŸ“¦ Installing Webhook API..."
          cd api
          mvn clean install -DskipTests
          
          echo "ğŸ“¦ Building & Testing Webhook App..."
          cd ../app
          mvn clean install -DskipTests=false

      # 2. Message Queue Service
      - name: Build Message Queue Service
        run: |
          echo "ğŸ“¦ Installing Message Queue Parent POM..."
          cd message-queue-service
          mvn -N clean install
          
          echo "ğŸ“¦ Installing Message Queue API..."
          cd api
          mvn clean install -DskipTests
          
          echo "ğŸ“¦ Building Message Queue App..."
          cd ../app
          mvn clean install -DskipTests

      # 3. Scenario Library Service
      - name: Build Scenario Library Service
        run: |
          echo "ğŸ“¦ Installing Scenario Parent POM..."
          cd scenario-library-service
          mvn -N clean install
          
          echo "ğŸ“¦ Installing Scenario API..."
          cd api
          mvn clean install -DskipTests
          
          echo "ğŸ“¦ Building Scenario App..."
          cd ../app
          mvn clean install -DskipTests

      # 4. Tracks Management Service
   
      - name: Build Tracks Management Service
        run: |
          echo "ğŸ“¦ Installing Tracks Parent POM..."
          cd tracks-management-service
          mvn -N clean install
          
          echo "ğŸ“¦ Installing Tracks API..."
          cd api
          mvn clean install -DskipTests
          
          echo "ğŸ“¦ Installing Tracks Database Module..."
          cd ../app-database
          mvn clean install -DskipTests
          
          echo "ğŸ“¦ Building Tracks App..."
          cd ../app
          mvn clean install -DskipTests

      # 5. DCO Gateway
     # 5. DCO Gateway
      - name: Build DCO Gateway
        run: |
          echo "ğŸ“¦ Installing Gateway Parent POM..."
          cd dco-gateway
          mvn -N clean install
          
          echo "ğŸ“¦ Installing Gateway API..."
          cd api
          mvn clean install -DskipTests
          
          echo "ğŸ“¦ Building Gateway App..."
          cd ../app
          mvn clean install -DskipTests

     # --- STAGE 3: BUILD UI (Next.js) ---
      - name: Build Developer Console UI
        run: |
          echo "ğŸ“¦ Installing UI Dependencies..."
          cd developer-console-ui/app
          npm install --legacy-peer-deps
          echo "ğŸ“¦ Building Next.js App..."
          npm run build

      # --- STAGE 4: START ENVIRONMENT ---
      - name: Start Docker Environment
        run: |
          # Using 'docker compose' (v2) syntax
          # We use --no-cache to force it to see the new files we just built
          docker compose build --no-cache
          docker compose up -d
          echo "â³ Waiting 60s for services to stabilize..."
          sleep 60

      # --- STAGE 5: HEALTH CHECKS ---
      - name: Verify Service Health
        run: |
          chmod +x ci-health-check.sh
          ./ci-health-check.sh

      # --- STAGE 6: SETUP DATABASE & RESTART ---
      - name: Setup Database & Refresh Webhook
        run: |
          echo "ğŸŒ± Seeding Database..."
          chmod +x seed-database.sh
          ./seed-database.sh
          
          echo "ğŸ”„ Restarting Webhook Service to recognize new schema..."
          docker compose restart webhook-management-service
          sleep 15

      # --- STAGE 7: FUNCTIONAL TESTS (Visual Output) ---
      - name: Run Functional E2E Tests
        run: |
          echo "ğŸš€ Starting Functional Tests..."
          chmod +x run-e2e-demo.sh
          ./run-e2e-demo.sh

      # --- DEBUGGING ---
      - name: Dump Docker Logs (If Failure)
        if: failure()
        run: |
          docker compose logs