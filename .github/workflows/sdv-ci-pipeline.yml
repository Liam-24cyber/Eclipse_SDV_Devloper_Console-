name: SDV Developer Console CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # --- STAGE 1: SETUP ---
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Set up Node.js (for Newman)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --- STAGE 2: BUILD & UNIT TEST ---
      
      # 1. Webhook Service (With Tests)
      # We explicitly build API first to ensure the dependency exists
      - name: Build & Test Webhook Service
        run: |
          echo "üì¶ Installing Webhook API..."
          cd webhook-management-service/api
          mvn clean install -DskipTests
          
          echo "üì¶ Building Webhook App..."
          cd ../app
          mvn clean install -DskipTests=false

      # 2. Message Queue Service (API First, Then App)
      - name: Build Message Queue Service
        run: |
          echo "üì¶ Installing Message Queue API..."
          cd message-queue-service/api
          mvn clean install -DskipTests
          
          echo "üì¶ Building Message Queue App..."
          cd ../app
          mvn clean install -DskipTests

      # 3. Scenario Library Service (API First, Then App)
      - name: Build Scenario Library Service
        run: |
          echo "üì¶ Installing Scenario API..."
          cd scenario-library-service/api
          mvn clean install -DskipTests
          
          echo "üì¶ Building Scenario App..."
          cd ../app
          mvn clean install -DskipTests

      # 4. Tracks Management Service (API First, Then App)
      - name: Build Tracks Management Service
        run: |
          echo "üì¶ Installing Tracks API..."
          cd tracks-management-service/api
          mvn clean install -DskipTests
          
          echo "üì¶ Building Tracks App..."
          cd ../app
          mvn clean install -DskipTests

      # 5. DCO Gateway (App Only)
      - name: Build DCO Gateway
        run: |
          echo "üì¶ Building DCO Gateway..."
          cd dco-gateway/app
          mvn clean install -DskipTests

      # --- STAGE 3: START ENVIRONMENT ---
      - name: Start Docker Environment
        run: |
          # Using 'docker compose' (v2) syntax
          docker compose up -d --build
          echo "‚è≥ Waiting 60s for services to stabilize..."
          sleep 60

      # --- STAGE 4: HEALTH CHECKS ---
      - name: Verify Service Health
        run: |
          echo "Checking API Gateway..."
          for i in {1..10}; do
            if curl -s http://localhost:8080/actuator/health | grep "UP"; then
              echo "‚úÖ Gateway is UP"
              break
            fi
            echo "zzZ Waiting for Gateway..."
            sleep 5
          done

      # --- STAGE 5: SEED DATABASE ---
      - name: Seed Database
        run: |
          chmod +x seed-database.sh
          ./seed-database.sh

      # --- STAGE 6: E2E WORKFLOW ---
      - name: Install Newman
        run: npm install -g newman

      - name: Run Postman E2E Tests
        run: |
          if [ -f "E2E_Demo_API.postman_collection.json" ]; then
            newman run E2E_Demo_API.postman_collection.json --reporters cli
          else
            echo "‚ö†Ô∏è Postman collection not found. Skipping E2E step for now."
          fi

      # --- DEBUGGING ---
      - name: Dump Docker Logs (If Failure)
        if: failure()
        run: |
          docker compose logs